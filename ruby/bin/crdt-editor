#!/usr/bin/env ruby

$stderr.sync = true
require 'optparse'

options = {}

parser = OptionParser.new do |opts|
  opts.banner = <<-BANNER.gsub(/^    /, '')
    Usage: crdt-editor [options] file.crdt
    Collaborative text editor. Press Ctrl+c to quit.

    Options:
  BANNER

  opts.on('-w', '--websocket ws://host:port/path', 'Connect to WebSocket server at this URL', String) do |url|
    options[:websocket] = url
  end
  opts.on('--debug-keys', 'Show keys that are pressed') { options[:debug_keys] = true }
  opts.on('-h', '--help', 'Show usage information')     { puts opts; exit(1) }
end

parser.parse!
options[:filename] = ARGV.shift

if options[:filename].nil? || options[:websocket].nil?
  $stderr.puts parser
  exit(1)
end

$LOAD_PATH.unshift(File.expand_path('../lib', File.dirname(__FILE__)))

require 'crdt'
require 'crdt/editor'

peer = if File.exists? options[:filename]
  CRDT::Peer.load(options[:filename])
else
  CRDT::Peer.new
end

CRDT::Editor.new(peer, options).run
